<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twittler | Welcome</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/app.css" />
    <script src="jquery.js"></script>
    <script src="underbar.js"></script>
    <script src="data_generator.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Exo:100,100italic,300,800italic' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <div class="row" style="position:fixed; height:170px">
      <div class="large-2 medium-4 columns logoBox">
        <h1 class="logo">t<span style="font-size: 80px">.</span></h1>
        <div class="home"><a href="#"><- Home</a></div>
      </div>
      <div class="large-7 medium-8 columns collapse textareaBox">
        <form id="youTweet" action="">
          <div class="large-10 columns">
            <h2>Contribute to the conversation:</h2>
              <input type="text" placeholder="Where in the world is Carmen San Diego #UCSD"></input>
          </div>
          <div class="large-2 columns show-for-large-up collapse">
            <input type="submit" value="Submit" class="medium success button">
          </div>
        </form>
      </div>
      <div class="large-3 show-for-large-up columns sideBarRight">
        <div class="large-3 show-for-large-up columns collapse overlayRight">
          <h3>Tweet of the day</h3>
          <h8>the president developed an entire security system #ballin</h8>
        </div>
      </div>
    </div>
    <div class="row" style="position:fixed; height:100%; top:170px; overflow:scroll">
      <div class="large-2 medium-4 columns sideBarLeft">
        <div class="large-2 medium-4 columns collapse overlay">
          <h3>Chirpiest Birds</h3>
          <h4>@rjatkinson</h4>
          <h4>@shawndrost</h4>
          <h4>@mracus</h4>
          <h4>@sharksforcheap</h4>
          <h4>@douglascalhoun</h4>
          <h3>Trending Topics</h3>
          <h4>#ballin</h4>
          <h4>#sxsw</h4>
          <h4>#sf</h4>
          <h4>#techlife</h4>
          <h4>#yolo</h4>
        </div>
      </div>
      <div class="large-7 large-offset-2 medium-8 medium-offset-4 columns" style="overflow:scroll">
        <div id="appContainer"></div>
      </div>
      <div class="large-3 show-for-large-up columns stats">
        <div><h1>37</h1><h7>new tweets</h7></div>
        <div><h1 style="color:#f96b5c">37</h1><h7>new topics</h7></div>
        <div><h1 style="color:#7dd4c9">37</h1><h7>new birds</h7></div>
      </div>
    </div>

    <script>

      $(document).ready(function(){

        launchStream(streams.home);

        // listen for user name link clicks and then show that user
        $("#appContainer").on("click","a",function(){
          launchStream(streams.users[$(this).text()]);
        });

        // listen for user name link clicks and then show that user
        $(".home").on("click","a",function(){
          launchStream(streams.home);
        });

        // listen for a new tweet submittal and show that tweet
        window.visitor = 'rjatkinsonBananaHammock';
        $("#youTweet").submit(function(event) {
          event.preventDefault();
          userTweets(window.visitor);
        });        
      
      });

      function userTweets(user){
        if(!streams.users[user]){streams.users[user] = [];}
        writeTweet($("#youTweet input[type=text]").val());
        _.last(streams.home)['created_at'] = new Date();
        _.last(streams.users[user])['created_at'] = new Date();
      }

      function launchStream(stream){
        if(stream===streams.home){$('.home').hide();}else{$('.home').show();}
        var $body = $('#appContainer');
        $body.html('');
        var baseTweetsReversed = _.last(stream,11).slice();
        var baseTweets = baseTweetsReversed.reverse();
        displayTweets(baseTweets,'appendTo',$body);
        getLatestTweets(stream);
      }

      function getLatestTweets(stream, timeOfLastTweet){
        window.latestTweets = _.filter(stream,function(item){return item.created_at > (timeOfLastTweet);});
        timeOfLastTweet = stream[stream.length-1].created_at;
        if(latestTweets[0]){displayTweets(latestTweets,'prependTo',$('#appContainer'));}
        var tweetChecker = setTimeout(getLatestTweets,1800,stream,timeOfLastTweet);
        $("#appContainer").on("click","a",function(){
          clearTimeout(tweetChecker);
        });
        $(".home").on("click","a",function(){
          clearTimeout(tweetChecker);
        });
      }

      function displayTweets(tweetArray,appendType,appendLocation){
        _.each(tweetArray,function(item){
          var $tweet = $("<div><h6>@<a href='#'>" + item.user + "</a></h6><h7>" + dateParse(item.created_at) + "</h7></div><h5>" + item.message + "</h5>");
          $tweet[appendType](appendLocation).hide().slideDown("slow");
        });
      }

      // utility function for parsing dates stored in tweets.created_at
      function dateParse(date) {
        var hourParse = function (hour) {
          return (hour > 12) ? hour - 12 : hour;
        };
        var parsedDate = [date.getFullYear(),
                        date.getMonth() + 1,
                        date.getDate(),
                        hourParse(date.getHours()),
                        date.getMinutes(),
                        date.getSeconds()];
        return parsedDate.join('-');
      }
    </script>
  </body>
</html>
