<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="underbar.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <div class="home"><a href="#">Home</a></div>
    <div id="appContainer"></div>
    <script>

      $(document).ready(function(){

        launchStream(streams.home);

        // listen for user name link clicks and then show that user
        $("#appContainer").on("click","a",function(){
          launchStream(streams.users[$(this).text()]);
        });
      
      });

      function launchStream(stream){
        if(stream===streams.home){$('.home').hide();}else{$('.home').show();}
        var $body = $('#appContainer');
        $body.html('');
        var baseTweets = _.last(stream,11);
        var index = stream.length - 1;
        displayTweets(baseTweets,'appendTo',$body);
        getLatestTweets(stream);
      }

      function getLatestTweets(stream, timeOfLastTweet){
        window.latestTweets = _.filter(stream,function(item){return item.created_at > (timeOfLastTweet);});
        timeOfLastTweet = (timeOfLastTweet) ? stream[stream.length-1].created_at : stream[stream.length-1].created_at;
        if(latestTweets[0]){displayTweets(latestTweets,'prependTo',$('#appContainer'));}
        var tweetChecker = setTimeout(getLatestTweets,4000,stream,timeOfLastTweet);
        $("#appContainer").on("click","a",function(){
          clearTimeout(tweetChecker);
        });
      }

      function displayTweets(tweetArray,appendType,appendLocation){
        _.each(tweetArray,function(item){
          var $tweet = $("<div>@<a href='#'>" + item.user + "</a>: " + item.message + " - created on: " + dateParse(item.created_at) + "</div>");
          $tweet[appendType](appendLocation);
        });
      }

      // utility function for parsing dates stored in tweets.created_at
      function dateParse(date) {
        var hourParse = function (hour) {
          return (hour > 12) ? hour - 12 : hour;
        };
        var parsedDate = [date.getFullYear(),
                        date.getMonth() + 1,
                        date.getDate(),
                        hourParse(date.getHours()),
                        date.getMinutes(),
                        date.getSeconds()];
        return parsedDate.join('-');
      }
    </script>
  </body>
</html>
